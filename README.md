# Telegram 媒体搜索机器人

这是一个用于Telegram群组的媒体搜索机器人，可以帮助用户在群组内搜索音频和视频文件。

## 功能

- 使用 `/f 关键词` 在群组内搜索媒体文件
- 分页显示搜索结果（每页10条）
- 文件名直接跳转到原始消息
- 当机器人加入新群组时，管理员可使用 `/index` 命令索引历史媒体文件

## 系统架构

该系统使用双客户端架构：
1. **机器人客户端**：使用 Bot API，处理用户交互和搜索命令
2. **用户客户端**：使用 User API，索引群组的历史消息

## 环境要求

- Python 3.9+
- MongoDB 4.0+
- Telegram API 密钥 (API ID 和 API HASH)
- Telegram Bot Token
- Telegram 用户账号（用于访问历史消息）
- Docker (用于运行MongoDB容器)
- (可选) 代理服务器，如果需要通过代理连接Telegram

## 运行步骤

### 重要说明：双客户端运行模式

本系统使用了双客户端架构，因此需要分两步运行：

1. **第一步**：运行用户认证脚本，生成用户会话文件（仅首次需要）
   ```bash
   python3 auth_user.py
   ```
   这步会要求您登录Telegram账号并生成会话文件，**只需执行一次**。

2. **第二步**：启动主程序
   ```bash
   python3 -m app.main
   ```
   或使用启动脚本（自动处理MongoDB）
   ```bash
   ./start_local.sh
   ```
   主程序会自动使用第一步生成的会话文件，不会要求重新登录。

## 会话管理机制

本系统对会话管理进行了优化：

1. **一次登录，多次使用**：
   - `auth_user.py`中登录后生成会话文件
   - `app/main.py`自动恢复会话，不会重复请求登录
   - 会话文件保存在项目根目录，命名为`{SESSION_NAME}_user.session`

2. **不干扰其他会话**：
   - 使用独特设备标识，被Telegram识别为独立设备
   - 只关闭自己的连接，不会撤销整个账号的授权
   - 停止时只调用`stop()`而非`LogOut()`，确保不影响其他设备

## 多设备会话管理

**重要特性：本机器人设计为与用户的其他Telegram会话共存**

1. **不会挤掉其他设备**：使用专门的设备标识，确保不会干扰其他设备的登录状态
2. **不会中断其他会话**：仅管理自己的连接，不会影响用户在手机、电脑等设备上的Telegram会话
3. **安全退出机制**：退出时只关闭当前连接，不会退出其他设备的会话

本系统通过以下技术手段实现多设备共存：
- 使用固定设备标识(`device_model`)，确保被Telegram服务器识别为独立设备
- 正确设置系统版本(`system_version`)和应用版本(`app_version`)，避免会话冲突
- 安全的连接管理，确保start()和stop()操作只影响当前实例

## 使用流程

1. 设置环境变量（API密钥、代理等）
2. 运行 `auth_user.py` 脚本，使用您的 Telegram 用户账号登录
3. 确保用户账号已加入所有需要索引的群组
4. 启动机器人 `python3 -m app.main` 或使用 `./start_local.sh`
5. 邀请机器人加入群组并给予管理员权限
6. 群组管理员使用 `/index` 命令索引历史媒体文件
7. 群组成员使用 `/f 关键词` 命令搜索媒体文件

## 为什么需要用户账号？

Telegram Bot API 不允许机器人访问群组的完整历史消息，这是一个安全限制。为了绕过这一限制：

1. 我们使用普通用户账号来访问和索引群组的历史消息
2. 用户账号需要是群组的成员才能访问消息
3. 机器人仍然负责处理搜索请求和用户交互

## 安全提示

- 确保在受信任的环境中使用用户会话
- 应用不会以任何方式修改您的Telegram账号设置
- 应用仅用于索引和搜索群组媒体文件，不会访问个人聊天
